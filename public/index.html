<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Realtime Gold Price (WIB)</title>

<style>
body{
  font-family:Arial,sans-serif;
  background:#111;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  height:100vh;
  margin:0
}
.card{
  background:#1a1a1a;
  padding:20px 24px;
  border-radius:12px;
  width:390px;
  box-shadow:0 8px 30px rgba(0,0,0,.6);
  border:1px solid #222
}
h1{font-size:18px;text-align:center;margin-bottom:6px}
.time{font-size:13px;color:#bbb;text-align:center;margin-bottom:10px}
.row{margin:12px 0}
.label{color:#aaa;font-size:13px}
.value{font-size:22px;font-weight:700}
.diff{font-size:12px;margin-top:4px}

.green{color:#4caf50}
.red{color:#ff6b6b}
.neutral{color:#999}
.fade{animation:pulse .25s ease-out}
@keyframes pulse{
  from{transform:scale(1.05);opacity:.3}
  to{transform:scale(1);opacity:1}
}

#spread{margin-top:12px;text-align:center;color:#f0e68c;font-weight:600}
#profit,#profit2{margin-top:8px;text-align:center;font-weight:600}

#bias{
  margin-top:14px;
  padding:10px;
  border-radius:8px;
  text-align:center;
  font-weight:700
}
.bias-up{background:#0f2e1a;color:#4caf50}
.bias-down{background:#2e1414;color:#ff6b6b}
.bias-neutral{background:#222;color:#aaa}

.small{font-size:12px;margin-top:6px;color:#bbb;text-align:center}

button{
  width:100%;
  margin-top:10px;
  padding:8px;
  border-radius:6px;
  border:none;
  background:#333;
  color:#ccc;
  cursor:pointer
}
</style>
</head>

<body>
<div class="card">

<h1>Realtime Gold Price</h1>
<div id="time" class="time">--:--:--</div>

<div class="row">
  <div class="label">Buying Rate</div>
  <div id="buy" class="value">Loading...</div>
  <div id="buyDiff" class="diff neutral">(0)</div>
</div>

<div class="row">
  <div class="label">Selling Rate</div>
  <div id="sell" class="value">Loading...</div>
  <div id="sellDiff" class="diff neutral">(0)</div>
</div>

<div id="spread">Spread: -</div>
<div id="profit">Profit 20jt: -</div>
<div id="profit2">Profit 30jt: -</div>

<div id="bias" class="bias-neutral">
5m Bias: UNCERTAIN
<div id="biasDetail" class="small"></div>
</div>

<div id="stats" class="small"></div>

<button id="reset">Reset Prediction Data</button>

</div>

<script>
/* ================= PROFIT ================= */
const nilaiEmas20=20000000, modal20=nilaiEmas20-685000;
const nilaiEmas30=30000000, modal30=nilaiEmas30-1020000;
const fmt=n=>n.toLocaleString("id-ID");

/* ================= CLOCK ================= */
let serverOffset=0;
async function syncTime(){
  try{
    const r=await fetch("https://worldtimeapi.org/api/timezone/Asia/Jakarta");
    const d=await r.json();
    serverOffset=d.unixtime-Math.floor(Date.now()/1000);
  }catch{}
}
function tick(){
  const t=new Date((Math.floor(Date.now()/1000)+serverOffset)*1000);
  time.innerText="Now WIB: "+t.toLocaleTimeString("id-ID",{hour12:false});
}
syncTime();setInterval(tick,1000);setInterval(syncTime,300000);

/* ================= HISTORY ================= */
const history=[];
let lastEvent=null;

/* ================= TREND ================= */
const TH=500;
function windowTrend(min){
  if(history.length<2)return"SIDE";
  const now=history.at(-1).t;
  const cut=now-min*60*1000;
  const w=history.filter(e=>e.t>=cut);
  if(w.length<2)return"SIDE";
  const d=w.at(-1).p-w[0].p;
  if(d>TH)return"UP";
  if(d<-TH)return"DOWN";
  return"SIDE";
}

/* ================= STORAGE ================= */
const KEY="gold_prediction_v1";
let log=JSON.parse(localStorage.getItem(KEY)||"[]");
const EXP=24*60*60*1000;

function save(){localStorage.setItem(KEY,JSON.stringify(log))}
log=log.filter(p=>Date.now()-p.t<EXP);save();

/* ================= PREDICTION ================= */
function recordPrediction(bias,conf,price){
  if(conf<60||bias==="UNCERTAIN")return;
  if(log.at(-1)&&Date.now()-log.at(-1).t<60000)return;

  log.push({
    t:Date.now(),
    price,
    bias,
    conf,
    resolved:false,
    result:null
  });
  save();
}

function resolve(price){
  log.forEach(p=>{
    if(p.resolved)return;
    if(Date.now()-p.t<5*60*1000)return;

    p.result=
      p.bias==="HIGHER"
        ? price>p.price?"WIN":"LOSS"
        : price<p.price?"WIN":"LOSS";
    p.resolved=true;
  });
  save();
}

function stats(){
  const d=log.filter(p=>p.resolved);
  if(!d.length){statsEl.innerText="No resolved prediction";return}
  const win=d.filter(p=>p.result==="WIN").length;
  statsEl.innerText=
    `Predictions: ${d.length} · Win: ${win} · Win-rate: ${Math.round(win/d.length*100)}%`;
}

/* ================= LOAD GOLD ================= */
let lastBuy=null,lastSell=null;
async function loadGold(){
  const r=await fetch("/api/gold",{cache:"no-store"});
  const d=await r.json();

  const buy=+d.buying_rate;
  const sell=+d.selling_rate;
  const t=new Date(d.updated_at.replace(" ","T")).getTime();
  if(lastEvent&&t<=lastEvent)return;
  lastEvent=t;

  history.push({t,p:buy});
  if(history.length>30)history.shift();

  buyEl.innerText=fmt(buy);
  sellEl.innerText=fmt(sell);
  spread.innerText="Spread: "+fmt(buy-sell);

  if(lastBuy!==null){
    buyDiff.innerHTML=
      buy>lastBuy?`<span class="green">⬆ +${fmt(buy-lastBuy)}</span>`:
      buy<lastBuy?`<span class="red">⬇ ${fmt(buy-lastBuy)}</span>`:"(0)";
  }

  const g20=nilaiEmas20/buy;
  profit.innerHTML=`Profit 20jt: Rp ${fmt(g20*sell-modal20)} (${(g20*sell-modal20)/sell} gr)`;

  const g30=nilaiEmas30/buy;
  profit2.innerHTML=`Profit 30jt: Rp ${fmt(g30*sell-modal30)} (${(g30*sell-modal30)/sell} gr)`;

  const t2=windowTrend(2),t3=windowTrend(3),t5=windowTrend(5);
  let bias="UNCERTAIN",cls="bias-neutral";
  if(t2==="UP"&&t3==="UP"&&t5==="UP"){bias="HIGHER";cls="bias-up"}
  if(t2==="DOWN"&&t3==="DOWN"&&t5==="DOWN"){bias="LOWER";cls="bias-down"}

  const conf=Math.round([t2,t3,t5].filter(x=>x!=="SIDE").length/3*100);
  biasEl.className=cls;
  biasEl.innerHTML=`5m Bias: ${bias}<div class="small">2m:${t2} · 3m:${t3} · 5m:${t5} · Confidence: ${conf}%</div>`;

  recordPrediction(bias,conf,buy);
  resolve(buy);
  stats();

  lastBuy=buy;lastSell=sell;
}

loadGold();
setInterval(loadGold,1000);

/* ================= RESET ================= */
reset.onclick=()=>{
  if(confirm("Hapus semua data prediksi?")){
    localStorage.removeItem(KEY);
    location.reload();
  }
};
</script>

</body>
</html>
