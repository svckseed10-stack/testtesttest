<script>
let lastBuy = null;
let lastSell = null;
let lastBuyDiff = 0;
let lastSellDiff = 0;

let fetchInterval = 1000; // default 1 detik
let fastFetchCount = 0;   // menghitung detik awal burst
const FAST_FETCH_LIMIT = 5; // fetch cepat di detik 1-5

function getJakartaTimeString() {
  const now = new Date();
  return new Intl.DateTimeFormat("en-US", {
    hour: "numeric",
    minute: "2-digit",
    second: "2-digit",
    hour12: true,
    timeZone: "Asia/Jakarta"
  }).format(now);
}

function formatNumber(n) {
  return n.toLocaleString("id-ID");
}

async function load() {
  try {
    const res = await fetch("/api/gold");
    const data = await res.json();

    // Update jam
    document.getElementById("time").innerText = getJakartaTimeString();

    const buy = parseFloat(data.buying_rate);
    const sell = parseFloat(data.selling_rate);

    const buyEl = document.getElementById("buy");
    const buyDiffEl = document.getElementById("buyDiff");
    buyEl.classList.remove("green", "red", "fade");

    const sellEl = document.getElementById("sell");
    const sellDiffEl = document.getElementById("sellDiff");
    sellEl.classList.remove("green", "red", "fade");

    // ===== BUY =====
    if (lastBuy !== null && buy !== lastBuy) {
      const diff = buy - lastBuy;
      lastBuyDiff = diff;
      if (diff > 0) buyEl.classList.add("green", "fade");
      else if (diff < 0) buyEl.classList.add("red", "fade");
    }

    if (lastBuyDiff > 0) buyDiffEl.innerHTML = `<span class="green">⬆ +${formatNumber(lastBuyDiff)}</span>`;
    else if (lastBuyDiff < 0) buyDiffEl.innerHTML = `<span class="red">⬇ ${formatNumber(lastBuyDiff)}</span>`;
    else buyDiffEl.innerHTML = `<span class="neutral">(0)</span>`;

    buyEl.innerText = formatNumber(buy);

    // ===== SELL =====
    if (lastSell !== null && sell !== lastSell) {
      const diff = sell - lastSell;
      lastSellDiff = diff;
      if (diff > 0) sellEl.classList.add("green", "fade");
      else if (diff < 0) sellEl.classList.add("red", "fade");
    }

    if (lastSellDiff > 0) sellDiffEl.innerHTML = `<span class="green">⬆ +${formatNumber(lastSellDiff)}</span>`;
    else if (lastSellDiff < 0) sellDiffEl.innerHTML = `<span class="red">⬇ ${formatNumber(lastSellDiff)}</span>`;
    else sellDiffEl.innerHTML = `<span class="neutral">(0)</span>`;

    sellEl.innerText = formatNumber(sell);

    // ===== SPREAD =====
    document.getElementById("spread").innerText =
      "Spread: " + formatNumber(buy - sell);

    lastBuy = buy;
    lastSell = sell;

    // ==== Adaptive polling ====
    fastFetchCount++;
    clearInterval(intervalId);
    if (fastFetchCount <= FAST_FETCH_LIMIT) {
      // masih detik awal → fetch cepat tiap 1 detik
      fetchInterval = 1000;
    } else {
      // setelah burst selesai → fetch lebih lambat tiap 5 detik
      fetchInterval = 5000;
    }
    intervalId = setInterval(load, fetchInterval);

  } catch (err) {
    console.error(err);
  }
}

// start
let intervalId = setInterval(load, fetchInterval);
load();
</script>
