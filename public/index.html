const modalBayar = 19315000;
const nilaiEmas = 20000000;

const modalBayarVarian2 = 30000000;
const diskonVarian2 = 1020000;

let lastBuy = null;
let lastSell = null;
let lastBuyDiff = 0;
let lastSellDiff = 0;

let lastProfitRate1 = null; 
let lastProfitRate2 = null; 

function getJakartaTimeString() {
  const now = new Date();
  return new Intl.DateTimeFormat("en-US", {
    hour: "numeric",
    minute: "2-digit",
    second: "2-digit",
    hour12: true,
    timeZone: "Asia/Jakarta"
  }).format(now);
}

function formatNumber(n) {
  return n.toLocaleString("id-ID");
}

/* -----------------------
   PROFIT VARIAN 1
-------------------------*/
function hitungProfit(sellingRate, buyingRate) {
  const jumlahGram = nilaiEmas / buyingRate;
  const totalJual = jumlahGram * sellingRate;
  const profitRupiah = totalJual - modalBayar;
  const profitGram = profitRupiah / sellingRate;
  return { profitRupiah, profitGram, jumlahGram };
}

function updateProfitUI(sellingRate, buyingRate) {
  if (lastProfitRate1 === sellingRate) return;
  lastProfitRate1 = sellingRate;

  const { profitRupiah, profitGram, jumlahGram } = hitungProfit(sellingRate, buyingRate);

  const profitEl = document.getElementById("profit");
  let color = profitRupiah > 0 ? "green" : profitRupiah < 0 ? "red" : "neutral";

  profitEl.innerHTML =
    `Profit: <span class="${color}">Rp ${profitRupiah.toLocaleString("id-ID")} (${profitGram.toFixed(4)} gr)</span><br>
     Jumlah Emas: ${jumlahGram.toFixed(4)} gr`;
}

/* -----------------------
   PROFIT VARIAN 2
-------------------------*/
function hitungProfitVarian2(sellingRate, buyingRate) {
  const jumlahGram = nilaiEmas / buyingRate;
  const totalJual = jumlahGram * sellingRate;
  const profitRupiah = totalJual - (modalBayarVarian2 - diskonVarian2);
  const profitGram = profitRupiah / sellingRate;
  return { profitRupiah, profitGram, jumlahGram };
}

function updateProfitUIVarian2(sellingRate, buyingRate) {
  if (lastProfitRate2 === sellingRate) return;
  lastProfitRate2 = sellingRate;

  const { profitRupiah, profitGram, jumlahGram } = hitungProfitVarian2(sellingRate, buyingRate);

  const profitEl = document.getElementById("profit2");
  let color = profitRupiah > 0 ? "green" : profitRupiah < 0 ? "red" : "neutral";

  profitEl.innerHTML =
    `Profit (30 jt - diskon 1.020.000): <span class="${color}">Rp ${profitRupiah.toLocaleString("id-ID")} (${profitGram.toFixed(4)} gr)</span><br>
     Jumlah Emas: ${jumlahGram.toFixed(4)} gr`;
}

/* -----------------------
   LOAD API
-------------------------*/
async function loadGold() {
  try {
    const res = await fetch("/api/gold");
    const data = await res.json();

    const buy = parseFloat(data.buying_rate);
    const sell = parseFloat(data.selling_rate);

    document.getElementById("time").innerText = getJakartaTimeString();

    const buyEl = document.getElementById("buy");
    const buyDiffEl = document.getElementById("buyDiff");

    const sellEl = document.getElementById("sell");
    const sellDiffEl = document.getElementById("sellDiff");

    // BUY
    if (lastBuy !== null && buy !== lastBuy) {
      const diff = buy - lastBuy;
      lastBuyDiff = diff;
      buyEl.classList.add(diff > 0 ? "green" : "red", "fade");
    }
    buyEl.innerText = formatNumber(buy);
    buyDiffEl.innerHTML =
      lastBuyDiff > 0 ? `<span class="green">⬆ +${formatNumber(lastBuyDiff)}</span>` :
      lastBuyDiff < 0 ? `<span class="red">⬇ ${formatNumber(lastBuyDiff)}</span>` :
      `<span class="neutral">(0)</span>`;

    // SELL
    if (lastSell !== null && sell !== lastSell) {
      const diff = sell - lastSell;
      lastSellDiff = diff;
      sellEl.classList.add(diff > 0 ? "green" : "red", "fade");
    }
    sellEl.innerText = formatNumber(sell);
    sellDiffEl.innerHTML =
      lastSellDiff > 0 ? `<span class="green">⬆ +${formatNumber(lastSellDiff)}</span>` :
      lastSellDiff < 0 ? `<span class="red">⬇ ${formatNumber(lastSellDiff)}</span>` :
      `<span class="neutral">(0)</span>`;

    // SPREAD
    document.getElementById("spread").innerText = "Spread: " + formatNumber(buy - sell);

    // PROFIT
    updateProfitUI(sell, buy);
    updateProfitUIVarian2(sell, buy);

    lastBuy = buy;
    lastSell = sell;

  } catch (err) {
    document.getElementById("buy").innerText = "Error";
    document.getElementById("sell").innerText = "Error";
    document.getElementById("profit").innerText = "Profit: -";
    document.getElementById("profit2").innerText = "Profit (30jt): -";
    console.error(err);
  }
}

loadGold();
setInterval(loadGold, 1000);
