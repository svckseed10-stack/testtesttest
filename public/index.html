<script>
let lastBuy = null;
let lastSell = null;

let lastBuyDiff = 0;
let lastSellDiff = 0;

// Format jam Asia/Jakarta
function getJakartaTimeString() {
  const now = new Date();
  return new Intl.DateTimeFormat("en-US", {
    hour: "numeric",
    minute: "2-digit",
    second: "2-digit",
    hour12: true,
    timeZone: "Asia/Jakarta"
  }).format(now);
}

function formatNumber(n) {
  return n.toLocaleString("id-ID");
}

async function load() {
  try {
    const res = await fetch("/api/gold");
    const data = await res.json();

    document.getElementById("time").innerText = getJakartaTimeString();

    const buy = Number(data.buying_rate);
    const sell = Number(data.selling_rate);

    // ----- BUY -----
    if (lastBuy !== null) {
      const diff = buy - lastBuy;

      if (diff !== 0) {
        // diff berubah → simpan diff baru
        lastBuyDiff = diff;
      }
    }

    // tampilkan buy
    const buyEl = document.getElementById("buy");
    buyEl.innerText = formatNumber(buy);

    const buyDiffEl = document.getElementById("buyDiff");
    if (lastBuyDiff > 0) {
      buyDiffEl.innerHTML = `<span class="green">⬆ +${lastBuyDiff}</span>`;
      buyEl.classList.add("green", "fade");
    } else if (lastBuyDiff < 0) {
      buyDiffEl.innerHTML = `<span class="red">⬇ ${lastBuyDiff}</span>`;
      buyEl.classList.add("red", "fade");
    } else {
      buyDiffEl.innerHTML = `<span class="neutral">(0)</span>`;
    }

    // ----- SELL -----
    if (lastSell !== null) {
      const diff = sell - lastSell;
      if (diff !== 0) {
        lastSellDiff = diff;
      }
    }

    const sellEl = document.getElementById("sell");
    sellEl.innerText = formatNumber(sell);

    const sellDiffEl = document.getElementById("sellDiff");
    if (lastSellDiff > 0) {
      sellDiffEl.innerHTML = `<span class="green">⬆ +${formatNumber(lastSellDiff)}</span>`;
      sellEl.classList.add("green", "fade");
    } else if (lastSellDiff < 0) {
      sellDiffEl.innerHTML = `<span class="red">⬇ ${formatNumber(lastSellDiff)}</span>`;
      sellEl.classList.add("red", "fade");
    } else {
      sellDiffEl.innerHTML = `<span class="neutral">(0)</span>`;
    }

    // ---- SPREAD ----
    document.getElementById("spread").innerText =
      "Spread: " + formatNumber(buy - sell);

    // simpan last values
    lastBuy = buy;
    lastSell = sell;

  } catch (e) {
    document.getElementById("buy").innerText = "Error";
    document.getElementById("sell").innerText = "Error";
  }
}

load();
setInterval(load, 1000);
</script>
